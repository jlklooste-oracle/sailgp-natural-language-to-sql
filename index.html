<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NL2SQL Demo</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <script type="module">
      function formatJSONasHTML(jsonData) {
        try {
          const data = JSON.parse(jsonData);

          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("Provided JSON is not an array or is empty.");
          }

          let result = "<table>";

          // Display headers
          result += '<tr class="theaderrow">';
          Object.keys(data[0]).forEach((name) => {
            result += `<th class="theader"><div class="theaderdiv">${escapeHTML(
              name
            )}</div></th>`;
          });
          result += "</tr>";

          // Display data
          data.forEach((row) => {
            result += "<tr>";
            Object.values(row).forEach((value) => {
              result += `<td class="tcell">${escapeHTML(value)}</td>`;
            });
            result += "</tr>";
          });

          result += "</table>";
          return result;
        } catch (e) {
          console.error("Invalid JSON data provided.", e);
          return "Invalid JSON data provided.";
        }
      }

      function escapeHTML(str) {
        return str
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      window.addEventListener("load", (event) => {
        document
          .querySelector(".sendMessage")
          .addEventListener("click", async (event) => {
            try {
              event.currentTarget.classList.add("is-loading");
              event.currentTarget.disabled = true;

              document
                .querySelector(".result")
                .parentElement.classList.add("is-hidden");
              document
                .querySelector(".error")
                .parentElement.classList.add("is-hidden");

              let currHour = new Date();

              //Step 1: Add the user input to the HTML output
              const messageValue = document.querySelector(".message").value; // Store the message value before clearing

              const userMsgTemplate = `<div class="columns">
                                  <div class="column is-one-third"></div>
                                  <div class="column">
                                      <div class="notification is-success">
                                          <h6 class="subtitle is-6">${
                                            currHour.getHours() +
                                            ":" +
                                            currHour.getMinutes()
                                          }</h6>
                                          ${messageValue}
                                      </div>
                                  </div>
                              </div>`;

              //Step 2: Call LLM to translate natural language to a SQL statement
              let chatBox = document.querySelector(".messageHistory");
              chatBox.innerHTML += userMsgTemplate;
              chatBox.scrollIntoView(false);
              document.querySelector(".message").value = "";
              let response = await fetch("llm.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  prompt: messageValue,
                }),
              });
              let llmJsonResponse = await response.json();
              console.log("llmJsonResponse.output", llmJsonResponse.output);
              //data.responseMessage = data.output.replace("\n", "<br>");
              let aiMsgTemplate = `<div class="columns">
                                                <div class="column">
                                                    <div class="notification is-info">
                                                        <h6 class="subtitle is-6">${
                                                          currHour.getHours() +
                                                          ":" +
                                                          currHour.getMinutes()
                                                        }</h6>
                                                        ${
                                                          llmJsonResponse.output
                                                        }
                                                    </div>
                                                </div>
                                                <div class="column is-one-third"></div>
                                            </div>`;

              chatBox.innerHTML += aiMsgTemplate;
              chatBox.scrollIntoView(false);

              //Step 3: Run SQL on database, we get the results as JSON, then convert that to HTML table format
              response = await fetch("sql.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  sql: llmJsonResponse.responseMessage,
                }),
              });
              let databaseJsonResponse = await response.json();
              currHour = new Date();
              let htmlOutput = formatJSONasHTML(databaseJsonResponse.output);
              let sqlMsgTemplate = `<div class="columns">
                                <div class="column">
                                    <div class="notification is-info">
                                        <h6 class="subtitle is-6">${
                                          currHour.getHours() +
                                          ":" +
                                          currHour.getMinutes()
                                        }</h6>
                                        ${htmlOutput}
                                    </div>
                                </div>
                                <div class="column is-one-third"></div>
                            </div>`;
              chatBox.innerHTML += sqlMsgTemplate;
              chatBox.scrollIntoView(false);

              //Step 4: Call LLM to translate results into natural language
              //Input is a) natural language question, b) the resulting SQL statement and c) the resulting dataset.
              //Output is the natural language answer to the question.
              let body = {
                prompt: messageValue,
                sql: llmJsonResponse.output,
                dataset: databaseJsonResponse.output,
              };
              console.log(">>>body for final llm call", body);
              response = await fetch("llm.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(body),
              });
              let llmFinalJsonResponse = await response.json();

              let finalMsgTemplate = `<div class="columns">
                                  <div class="column">
                                      <div class="notification is-info">
                                          <h6 class="subtitle is-6">${
                                            currHour.getHours() +
                                            ":" +
                                            currHour.getMinutes()
                                          }</h6>
                                          ${llmFinalJsonResponse.output}
                                      </div>
                                  </div>
                                  <div class="column is-one-third"></div>
                              </div>`;

              chatBox.innerHTML += finalMsgTemplate;
              chatBox.scrollIntoView(false);
            } catch (error) {
              console.error("Error:", error);
            } finally {
              document
                .querySelector(".sendMessage")
                .classList.remove("is-loading");
              document.querySelector(".sendMessage").disabled = false;
            }
          });
      });
    </script>
  </head>

  <body>
    <section class="section">
      <div class="container">
        <div class="columns box">
          <div class="column">
            <div class="columns">
              <div class="column has-text-centered">
                <h1 class="title">Natural Language 2 SQL Demo</h1>
              </div>
            </div>
            <div class="columns">
              <div class="column">
                <div
                  class="card-content"
                  style="
                    height: 600px;
                    overflow: auto;
                    flex-grow: 1;
                    flex-shrink: 1;
                  "
                >
                  <div class="content messageHistory"></div>
                </div>
              </div>
            </div>

            <div class="columns">
              <div class="column">
                <input
                  class="input message"
                  type="text"
                  placeholder="Type your message"
                  value="What was the maximum boat speed reached by England?"
                />
              </div>
              <div class="column is-narrow">
                <button class="button is-info sendMessage">Send</button>
              </div>
            </div>
          </div>
        </div>
        <div class="columns box is-hidden">
          <div class="column result"></div>
        </div>
        <div class="columns box is-hidden">
          <div
            class="column notification is-danger error has-text-centered"
          ></div>
        </div>
      </div>
    </section>
  </body>
</html>
