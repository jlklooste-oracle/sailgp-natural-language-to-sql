<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NL2SQL Demo</title>
    <style>
      .is-hidden {
        display: none;
      }
    </style>
    <link rel="stylesheet" href="styles.css" />
    <script type="module">
      function formatJSONasHTML(jsonData) {
        try {
          const data = JSON.parse(jsonData);

          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("Provided JSON is not an array or is empty.");
          }

          let result = "<table>";

          // Display headers
          result += '<tr class="theaderrow">';
          Object.keys(data[0]).forEach((name) => {
            result += `<th class="theader"><div class="theaderdiv">${escapeHTML(
              name
            )}</div></th>`;
          });
          result += "</tr>";

          // Display data
          data.forEach((row) => {
            result += "<tr>";
            Object.values(row).forEach((value) => {
              result += `<td class="tcell">${escapeHTML(value)}</td>`;
            });
            result += "</tr>";
          });

          result += "</table>";
          return result;
        } catch (e) {
          console.error("Invalid JSON data provided.", e);
          return "Invalid JSON data provided.";
        }
      }

      function escapeHTML(str) {
        return str
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      window.addEventListener("load", (event) => {
        document
          .querySelector(".sendMessage")
          .addEventListener("click", async (event) => {
            try {
              event.currentTarget.classList.add("is-loading");
              event.currentTarget.disabled = true;

              document
                .querySelector(".result")
                .parentElement.classList.add("is-hidden");
              document
                .querySelector(".error")
                .parentElement.classList.add("is-hidden");

              let currHour = new Date();

              //Step 1: Add the user input to the HTML output
              const messageValue = document.querySelector(".message").value; // Store the message value before clearing

              const userMsgTemplate = `<div class="chatUser">
                test
                              </div>`;
              //                              ${messageValue}

              //Step 2: Call LLM to translate natural language to a SQL statement
              let chatBox = document.querySelector(".chatContainerFlexCol");
              chatBox.innerHTML += userMsgTemplate;
              chatBox.scrollIntoView(false);

              let aiMsgTemplate = `<div class="columns">
                                                <div class="column">
                                                    <div class="notification is-info">
                                                        <h6 class="subtitle is-6">Assistant</h6>
                                                    </div>
                                                </div>
                                                <div class="column is-one-third"></div>
                                            </div>`;

              //                                                        ${llmJsonResponse.output}
              chatBox.innerHTML += aiMsgTemplate;
              chatBox.scrollIntoView(false);

              document.querySelector(".message").value = "";
              let response = await fetch("llm.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  prompt: messageValue,
                }),
              });
              let llmJsonResponse = await response.json();
              console.log("llmJsonResponse.output", llmJsonResponse.output);
              //data.responseMessage = data.output.replace("\n", "<br>");

              //Step 3: Run SQL on database, we get the results as JSON, then convert that to HTML table format
              response = await fetch("sql.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  sql: llmJsonResponse.responseMessage,
                }),
              });
              let databaseJsonResponse = await response.json();
              currHour = new Date();
              let htmlOutput = formatJSONasHTML(databaseJsonResponse.output);
              let sqlMsgTemplate = `<div class="columns">
                                <div class="column">
                                    <div class="notification is-info">
                                        <h6 class="subtitle is-6">Assistant - Execute SQL</h6>
                                        ${htmlOutput}
                                    </div>
                                </div>
                                <div class="column is-one-third"></div>
                            </div>`;
              chatBox.innerHTML += sqlMsgTemplate;
              chatBox.scrollIntoView(false);

              //Step 4: Call LLM to translate results into natural language
              //Input is a) natural language question, b) the resulting SQL statement and c) the resulting dataset.
              //Output is the natural language answer to the question.
              let body = {
                prompt: messageValue,
                sql: llmJsonResponse.output,
                dataset: databaseJsonResponse.output,
              };
              console.log(">>>body for final llm call", body);
              response = await fetch("llm.php", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(body),
              });
              let llmFinalJsonResponse = await response.json();

              let finalMsgTemplate = `<div class="columns">
                                  <div class="column">
                                      <div class="notification is-info">
                                          <h6 class="subtitle is-6">Assistant - Create natural language answer</h6>
                                          ${llmFinalJsonResponse.output}
                                      </div>
                                  </div>
                                  <div class="column is-one-third"></div>
                              </div>`;

              chatBox.innerHTML += finalMsgTemplate;
              chatBox.scrollIntoView(false);
            } catch (error) {
              console.error("Error:", error);
            } finally {
              document
                .querySelector(".sendMessage")
                .classList.remove("is-loading");
              document.querySelector(".sendMessage").disabled = false;
            }
          });
      });
    </script>
  </head>

  <body class="bodystyles">
    <div class="header">
      <div class="headertop">
        <img src="logo.png" alt="Logo" />
        <div class="spacer"></div>
        <div class="buttons">
          <div class="action-button red">TICKETS</div>
          <div class="action-button striped">THE DOCK</div>
          <div class="action-button white">
            MENU&nbsp;&nbsp;<svg
              stroke="currentColor"
              fill="currentColor"
              stroke-width="0"
              class="c-button-menu__icon"
              height="1em"
              width="1em"
              viewBox="0 0 24 24"
            >
              <path
                d="M 0 0 L 24 0 L 24 2.18182 L 0 2.18182 L 0 0 Z M 0 10.9091 L 24 10.9091 L 24 13.0909 L 0 13.0909 L 0 10.9091 Z M 0 21.8182 L 24 21.8182 L 24 24 L 0 24 L 0 21.8182 Z"
              ></path>
            </svg>
          </div>
        </div>
      </div>
      <div class="headerbottom">
        <div class="breadcrumb">FAN SECTION</div>
        <div class="slash"></div>
        <div class="breadcrumb selected">ASK US</div>
      </div>
    </div>

    <div class="container">
      <div
        class="chatContainerFlexCol"
        style="border: 1; border-style: solid"
      ></div>
    </div>

    <!--
    <div
      style={{
        width: "100vw",
        display: "flex",
        justifyContent: "center",
        alignItems: "center",
        backgroundColor: `#343541`,
        height: "112px",
        position: "fixed",
        bottom: 0,
      }}
    >
      <div
        style={{
          paddingTop: "10px",
          paddingBottom: "10px",
          width: "600px",
          display: "flex",
          flexDirection: "column",
          gap: "15px",
        }}
      >
        <div
          style={{
            backgroundColor: "#40414f",
            borderRadius: "12px",
            display: "flex",
            alignItems: "center",
            paddingRight: "10px",
          }}
        >
          <div
            style={{
              padding: "13px",
              height: "50px",
              flexGrow: 1,
            }}
          >
            <input
              className="inputFieldChat"
              style={{
                width: "100%",
                border: "none",
                outline: "none",
                padding: "0px",
              }}
              autoFocus
              placeholder="Send a message"
              value={newChatLine}
              onChange={(event) => setNewChatLine(event.target.value)}
              onKeyDown={(event) => {
                if (event.key === "Enter") {
                  addToChat();
                }
              }}
            />
          </div>
          <div
            style={{
              display: "flex",
              justifyContent: "center",
              alignItems: "center",
              width: "32px",
              height: "32px",
              borderRadius: "5px",
              backgroundColor: newChatLine ? "#d18ee2" : "transparent",
              cursor: newChatLine ? "pointer" : "not-allowed",
            }}
            onClick={newChatLine ? addToChat : null}
          >
            <img
              src={sendIcon}
              alt="Send"
              width="20px"
              style={{ filter: "invert(100%)" }}
            />
          </div>
        </div>
      </div>
    </div>-->

    <div class="chatInputFooter">
      <div class="chatBox">
        <input
          class="inputFieldChat"
          autofocus
          placeholder="Type your question"
          value="What was the maximum boat speed reached by England?"
          onKeyDown=...
        />
        <img
                src="/images/sendIcon.svg"
                alt="Send"
                width="20px"
              />
      </div>
    </div>

    <div class="footer">
      <div class="footerImages">
        <img src="logo.png" alt="SailGP Logo Web" />
        &nbsp;
        <img
          src="world_sailing.svg"
          style="filter: brightness(0) invert(1)"
          alt="World Sailing Logo"
        />
      </div>
    </div>
  </body>

  <!--  <body>
    <section class="section">
      <div class="container">
        <div class="columns box">
          <div class="column">
            <div class="columns">
              <div class="column has-text-centered">
                <h1 class="title">Natural Language 2 SQL Demo</h1>
              </div>
            </div>
            <div class="chatContainerFlexCol">
            </div>

            <div class="columns">
              <div class="column">
                <input
                  class="input message"
                  type="text"
                  placeholder="Type your message"
                  value="What was the maximum boat speed reached by England?"
                />
              </div>
              <div class="column is-narrow">
                <button class="button is-info sendMessage">Send</button>
              </div>
            </div>
          </div>
        </div>
        <div class="columns box is-hidden">
          <div class="column result"></div>
        </div>
        <div class="columns box is-hidden">
          <div
            class="column notification is-danger error has-text-centered"
          ></div>
        </div>
      </div>
    </section>
  </body>
--></html>
